<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Synthesizer of KeroppaⅣ</title>
  <style>
    :root{
      --bg:#ffffff;
      --panel:#fbfbfb;
      --border:#d9d9d9;
      --text:#111;
      --muted:#666;
      --btn:#ffffff;
      --btn2:#ffffff;
      --accent:#111;
    }
    *{ box-sizing:border-box; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans JP", sans-serif;
      margin:24px;
      color:var(--text);
      background:var(--bg);
    }
    h1{ font-size:22px; margin:0 0 14px; font-weight:700;}
    .grid{
      display:grid;
      grid-template-columns: 34px repeat(6, minmax(170px, 1fr));
      gap:14px;
      align-items:stretch;
    }
    .rowLabel{
      font-weight:700;
      font-size:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--text);
    }
    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px 12px 10px;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
      min-height:92px;
    }
    .cardTitle{
      font-weight:700;
      font-size:14px;
      margin-bottom:8px;
    }
    .ctrlRow{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .sliderWrap{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    input[type="range"]{ width:100%; }
    .valueText{
      font-variant-numeric: tabular-nums;
      color:var(--muted);
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .stepper{
      display:flex;
      flex-direction:column;
      gap:6px;
      user-select:none;
      align-items:stretch;
    }
    .stepper button{
      width:34px;
      height:28px;
      border:1px solid var(--border);
      background:var(--btn);
      color:var(--text);
      border-radius:8px;
      cursor:pointer;
      font-weight:800;
      line-height:1;
    }
    .stepper button:active{ transform: translateY(1px); }
    .muteBtn{
      width:34px;
      height:32px;
      border:1px solid var(--border);
      background:var(--btn2);
      color:var(--text);
      border-radius:8px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.02em;
    }
    .muteBtn.on{
      background:#ffe8e8;
      border-color:#e0a3a3;
      color:#7a0000;
    }
    select{
      width:100%;
      height:32px;
      border:1px solid var(--border);
      border-radius:8px;
      background:var(--btn);
      color:var(--text);
      padding:4px 8px;
      font-size:14px;
    }
    .bottomBar{
      margin-top:18px;
      display:flex;
      align-items:center;
      gap:14px;
      flex-wrap:wrap;
    }
    .bottomBar label{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:700;
    }
    .bottomBar select{
      width:auto;
      min-width:220px;
    }
    .miniCtrl{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--panel);
      min-width:320px;
    }
    .miniCtrl .lbl{
      font-weight:900;
      white-space:nowrap;
    }
    .miniCtrl input[type="range"]{
      flex:1;
      min-width:160px;
    }
    .miniCtrl .val{
      font-variant-numeric: tabular-nums;
      color:var(--muted);
      font-weight:800;
      min-width:110px;
      text-align:right;
    }
    .miniSel{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--panel);
    }
    .miniSel .lbl{
      font-weight:900;
      white-space:nowrap;
    }
    .miniSel select{
      min-width:150px;
      width:auto;
    }
    button.small{
      padding:9px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--btn);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
    }
    button.small:active{ transform: translateY(1px); }

    .btns{
      margin-left:auto;
      display:flex;
      gap:10px;
    }
    button.primary{
      padding:10px 16px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--accent);
      color:#fff;
      cursor:pointer;
      font-weight:900;
    }
    button.secondary{
      padding:10px 16px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--btn);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
    }
    .note{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }
    .note code{ color:var(--text); }
  
    .miniMap{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--panel);
      width: fit-content;
      max-width: 100%;
      flex: 0 0 auto;
    }
    .miniMap .lbl{
      font-weight:900;
      white-space:nowrap;
    }
    .miniMap .mapText{
      font-variant-numeric: tabular-nums;
      color:var(--text);
      font-weight:800;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      width:auto;
      max-width: 60vw;
    }

  
    .miniMap .mapText span{
      display:inline-block;
      margin-right: 1em; /* approx two half-width spaces */
    }


  
    /* ======== Pseudo Pages ======== */
    .page{ display:block; }
    .page.hidden{ display:none; }

    .helpWrap{
      max-width: 820px;
      margin: 0 auto;
    }
    .helpCard{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:12px;
      padding:18px 18px 16px;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
    }
    .helpText{
      margin-top: 8px;
      font-size: 14px;
      line-height: 1.75;
      color: var(--text);
      white-space: normal;
    }
    .helpBackRow{
      display:flex;
      justify-content:center;
      margin-top: 18px;
    }

  </style>
</head>
<body>  <div id="pageMain" class="page">

  <h1>Synthesizer of KeroppaⅣ</h1>

  <div class="grid" id="uiGrid">
    <!-- ===== Row A ===== -->
    <div class="rowLabel">A</div>
    <div class="card" data-voice="0" data-param="vol">
      <div class="cardTitle">音量</div>
      <div class="ctrlRow">
        <div class="sliderWrap">
          <input type="range" min="0" max="100" step="1" value="12">
          <div class="valueText"><span class="val"></span></div>
        </div>
        <div class="stepper"><button class="up">▲</button><button class="down">▼</button><button class="muteBtn" title="Mute">M</button></div>
      </div>
    </div>
    <div class="card" data-voice="0" data-param="freq">
      <div class="cardTitle">周波数</div>
      <div class="ctrlRow">
        <div class="sliderWrap"><input type="range" min="40" max="2000" step="1" value="250"><div class="valueText"><span class="val"></span></div></div>
        <div class="stepper"><button class="up">▲</button><button class="down">▼</button></div>
      </div>
    </div>
    <div class="card" data-voice="0" data-param="wave">
      <div class="cardTitle">波形</div>
      <div class="ctrlRow">
        <div class="sliderWrap">
          <select><option value="sine">sine</option><option value="triangle">triangle</option><option value="square" selected>square</option><option value="sawtooth">sawtooth</option></select>
          <div class="valueText"><span class="val"></span></div>
        </div>
        <div class="stepper"><button class="up">▲</button><button class="down">▼</button></div>
      </div>
    </div>
    <div class="card" data-voice="0" data-param="filt">
      <div class="cardTitle">フィルタ（LPF）</div>
      <div class="ctrlRow">
        <div class="sliderWrap"><input type="range" min="100" max="8000" step="1" value="1057"><div class="valueText"><span class="val"></span></div></div>
        <div class="stepper"><button class="up">▲</button><button class="down">▼</button></div>
      </div>
    </div>
    <div class="card" data-voice="0" data-param="modDepth">
      <div class="cardTitle">変調（ビブラート量）</div>
      <div class="ctrlRow">
        <div class="sliderWrap"><input type="range" min="0" max="100" step="1" value="0"><div class="valueText"><span class="val"></span></div></div>
        <div class="stepper"><button class="up">▲</button><button class="down">▼</button></div>
      </div>
    </div>
    <div class="card" data-voice="0" data-param="modRate">
      <div class="cardTitle">変調 速度</div>
      <div class="ctrlRow">
        <div class="sliderWrap"><input type="range" min="1" max="200" step="1" value="19"><div class="valueText"><span class="val"></span></div></div>
        <div class="stepper"><button class="up">▲</button><button class="down">▼</button></div>
      </div>
    </div>

    <!-- ===== Row B ===== -->
    <div class="rowLabel">B</div>
    <div class="card" data-voice="1" data-param="vol">
      <div class="cardTitle">音量</div>
      <div class="ctrlRow">
        <div class="sliderWrap"><input type="range" min="0" max="100" step="1" value="12"><div class="valueText"><span class="val"></span></div></div>
        <div class="stepper"><button class="up">▲</button><button class="down">▼</button><button class="muteBtn" title="Mute">M</button></div>
      </div>
    </div>
    <div class="card" data-voice="1" data-param="freq">
      <div class="cardTitle">周波数</div>
      <div class="ctrlRow">
        <div class="sliderWrap"><input type="range" min="40" max="2000" step="1" value="250"><div class="valueText"><span class="val"></span></div></div>
        <div class="stepper"><button class="up">▲</button><button class="down">▼</button></div>
      </div>
    </div>
    <div class="card" data-voice="1" data-param="wave">
      <div class="cardTitle">波形</div>
      <div class="ctrlRow">
        <div class="sliderWrap">
          <select><option value="sine">sine</option><option value="triangle">triangle</option><option value="square" selected>square</option><option value="sawtooth">sawtooth</option></select>
          <div class="valueText"><span class="val"></span></div>
        </div>
        <div class="stepper"><button class="up">▲</button><button class="down">▼</button></div>
      </div>
    </div>
    <div class="card" data-voice="1" data-param="filt">
      <div class="cardTitle">フィルタ（LPF）</div>
      <div class="ctrlRow">
        <div class="sliderWrap"><input type="range" min="100" max="8000" step="1" value="1057"><div class="valueText"><span class="val"></span></div></div>
        <div class="stepper"><button class="up">▲</button><button class="down">▼</button></div>
      </div>
    </div>
    <div class="card" data-voice="1" data-param="modDepth">
      <div class="cardTitle">変調（ビブラート量）</div>
      <div class="ctrlRow">
        <div class="sliderWrap"><input type="range" min="0" max="100" step="1" value="0"><div class="valueText"><span class="val"></span></div></div>
        <div class="stepper"><button class="up">▲</button><button class="down">▼</button></div>
      </div>
    </div>
    <div class="card" data-voice="1" data-param="modRate">
      <div class="cardTitle">変調 速度</div>
      <div class="ctrlRow">
        <div class="sliderWrap"><input type="range" min="1" max="200" step="1" value="19"><div class="valueText"><span class="val"></span></div></div>
        <div class="stepper"><button class="up">▲</button><button class="down">▼</button></div>
      </div>
    </div>

    <!-- ===== Row C ===== -->
    <div class="rowLabel">C</div>
    <div class="card" data-voice="2" data-param="vol">
      <div class="cardTitle">音量</div>
      <div class="ctrlRow">
        <div class="sliderWrap"><input type="range" min="0" max="100" step="1" value="12"><div class="valueText"><span class="val"></span></div></div>
        <div class="stepper"><button class="up">▲</button><button class="down">▼</button><button class="muteBtn" title="Mute">M</button></div>
      </div>
    </div>
    <div class="card" data-voice="2" data-param="freq">
      <div class="cardTitle">周波数</div>
      <div class="ctrlRow">
        <div class="sliderWrap"><input type="range" min="40" max="2000" step="1" value="250"><div class="valueText"><span class="val"></span></div></div>
        <div class="stepper"><button class="up">▲</button><button class="down">▼</button></div>
      </div>
    </div>
    <div class="card" data-voice="2" data-param="wave">
      <div class="cardTitle">波形</div>
      <div class="ctrlRow">
        <div class="sliderWrap">
          <select><option value="sine">sine</option><option value="triangle">triangle</option><option value="square" selected>square</option><option value="sawtooth">sawtooth</option></select>
          <div class="valueText"><span class="val"></span></div>
        </div>
        <div class="stepper"><button class="up">▲</button><button class="down">▼</button></div>
      </div>
    </div>
    <div class="card" data-voice="2" data-param="filt">
      <div class="cardTitle">フィルタ（LPF）</div>
      <div class="ctrlRow">
        <div class="sliderWrap"><input type="range" min="100" max="8000" step="1" value="1057"><div class="valueText"><span class="val"></span></div></div>
        <div class="stepper"><button class="up">▲</button><button class="down">▼</button></div>
      </div>
    </div>
    <div class="card" data-voice="2" data-param="modDepth">
      <div class="cardTitle">変調（ビブラート量）</div>
      <div class="ctrlRow">
        <div class="sliderWrap"><input type="range" min="0" max="100" step="1" value="0"><div class="valueText"><span class="val"></span></div></div>
        <div class="stepper"><button class="up">▲</button><button class="down">▼</button></div>
      </div>
    </div>
    <div class="card" data-voice="2" data-param="modRate">
      <div class="cardTitle">変調 速度</div>
      <div class="ctrlRow">
        <div class="sliderWrap"><input type="range" min="1" max="200" step="1" value="19"><div class="valueText"><span class="val"></span></div></div>
        <div class="stepper"><button class="up">▲</button><button class="down">▼</button></div>
      </div>
    </div>

    <!-- ===== Row D ===== -->
    <div class="rowLabel">D</div>
    <div class="card" data-voice="3" data-param="vol">
      <div class="cardTitle">音量</div>
      <div class="ctrlRow">
        <div class="sliderWrap"><input type="range" min="0" max="100" step="1" value="12"><div class="valueText"><span class="val"></span></div></div>
        <div class="stepper"><button class="up">▲</button><button class="down">▼</button><button class="muteBtn" title="Mute">M</button></div>
      </div>
    </div>
    <div class="card" data-voice="3" data-param="freq">
      <div class="cardTitle">周波数</div>
      <div class="ctrlRow">
        <div class="sliderWrap"><input type="range" min="40" max="2000" step="1" value="250"><div class="valueText"><span class="val"></span></div></div>
        <div class="stepper"><button class="up">▲</button><button class="down">▼</button></div>
      </div>
    </div>
    <div class="card" data-voice="3" data-param="wave">
      <div class="cardTitle">波形</div>
      <div class="ctrlRow">
        <div class="sliderWrap">
          <select><option value="sine">sine</option><option value="triangle">triangle</option><option value="square" selected>square</option><option value="sawtooth">sawtooth</option></select>
          <div class="valueText"><span class="val"></span></div>
        </div>
        <div class="stepper"><button class="up">▲</button><button class="down">▼</button></div>
      </div>
    </div>
    <div class="card" data-voice="3" data-param="filt">
      <div class="cardTitle">フィルタ（LPF）</div>
      <div class="ctrlRow">
        <div class="sliderWrap"><input type="range" min="100" max="8000" step="1" value="1057"><div class="valueText"><span class="val"></span></div></div>
        <div class="stepper"><button class="up">▲</button><button class="down">▼</button></div>
      </div>
    </div>
    <div class="card" data-voice="3" data-param="modDepth">
      <div class="cardTitle">変調（ビブラート量）</div>
      <div class="ctrlRow">
        <div class="sliderWrap"><input type="range" min="0" max="100" step="1" value="0"><div class="valueText"><span class="val"></span></div></div>
        <div class="stepper"><button class="up">▲</button><button class="down">▼</button></div>
      </div>
    </div>
    <div class="card" data-voice="3" data-param="modRate">
      <div class="cardTitle">変調 速度</div>
      <div class="ctrlRow">
        <div class="sliderWrap"><input type="range" min="1" max="200" step="1" value="19"><div class="valueText"><span class="val"></span></div></div>
        <div class="stepper"><button class="up">▲</button><button class="down">▼</button></div>
      </div>
    </div>
  </div>

  <div class="bottomBar">
    <label>コードチャンネル
      <select id="chChanSel"></select>
    </label>

    <label>オクターブ
      <select id="octSel">
        <option value="2">C2</option>
        <option value="3">C3</option>
        <option value="4" selected>C4</option>
        <option value="5">C5</option>
      </select>
    </label>

    <div class="miniCtrl" title="Noise mix amount (global, timbre mute independent)">
      <div class="lbl">ノイズ（量）</div>
      <input id="noiseAmt" type="range" min="0" max="100" step="1" value="0">
      <div class="val" id="noiseAmtVal">0 / 100</div>
    </div>

    <div class="miniCtrl" title="Noise color (LPF cutoff)">
      <div class="lbl">ノイズ（色）</div>
      <input id="noiseCol" type="range" min="200" max="12000" step="10" value="6000">
      <div class="val" id="noiseColVal">6000 Hz</div>
    </div>

    <div class="miniSel" title="Register chord to a channel (0..9)">
      <div class="lbl">登録</div>
      <select id="regChanSel"></select>
      <select id="regRootSel"></select>
      <select id="regQualSel"></select>
      <button class="small" id="regCommitBtn">登録確定</button>
    </div>

    <div class="miniMap" title="コードチャンネル対応表">
      <div class="lbl">対応</div>
      <div class="mapText" id="chMapText"></div>
    </div>

    <div class="btns">
            <button class="secondary" id="helpBtn" type="button">説明</button>
<button class="primary" id="playBtn">PLAY</button>
      <button class="secondary" id="stopBtn" disabled>STOP</button>
    </div>
  </div>

  <div class="note">
    仕様: コードチャンネル選択で周波数を上書き。割り当てコードは変更可能。<br>
    割当: A=最高音 / B=2番目 / C=3番目 / D=最低音（ハイ→ロー）。<br>
    ショートカット: コードチャンネルは <code>0</code>〜<code>9</code>。オクターブは <code>A</code>=C2 / <code>S</code>=C3 / <code>D</code>=C4 / <code>F</code>=C5。/ <code>Space</code>=PLAY・STOP。
  </div>

  </div>


  <div id="pageHelp" class="page hidden">
    <h1>説明</h1>
    <div class="helpWrap">
      <div class="helpCard">
        <div class="cardTitle">使い方</div>
        <div class="helpText">
          <div>PLAY を押すと発音（Space で PLAY/STOP 切替）。</div>
          <div>音色は4つ（高音から A / B / C / D）。</div>
          <div>コードチャンネルで和音（コード）を変更（ショートカット：0〜9）。</div>
          <div>オクターブで全体の高さを一括変更（ショートカット：A/S/D/F）。</div>
          <div>各音色は 周波数で音程、波形 / フィルタで音色変化。</div>
          <div>変調（量）/ 変調 速度でビブラート調整。</div>
          <div>コードを選び、音色を変えつつ全体バランスを調整するなど。</div>
          <div>コードチャンネルを切り替えながら簡易演奏が可能。</div>
          <div>いい感じのコードをコードチャンネルに割り当てるといい感じになる。</div>
        </div>
        <div class="helpBackRow">
          <button class="primary" id="helpBackBtn" type="button">戻る</button>
        </div>
      </div>
    </div>
  </div>


<script>
(() => {
  const WAVE_ORDER = ["sine","triangle","square","sawtooth"];
  const VOICES = 4; // A,B,C,D

  const voicesState = [
    { vol:12, muted:false, freq:250, wave:"square", filt:1057, modDepth:0, modRate:19 }, // A (highest)
    { vol:12, muted:false, freq:250, wave:"square", filt:1057, modDepth:0, modRate:19 }, // B
    { vol:12, muted:false, freq:250, wave:"square", filt:1057, modDepth:0, modRate:19 }, // C
    { vol:12, muted:false, freq:250, wave:"square", filt:1057, modDepth:0, modRate:19 }, // D (lowest)
  ];

  // ======== Global Noise (single instance; independent of timbre mute) ========
  const noiseState = { amount:0, color:6000 };
  const NOISE_MASTER = 1.0;

  function noiseAmountToGain(a0_100){
    const x = Math.max(0, Math.min(100, a0_100)) / 100;
    return Math.max(0.0001, (x * x) * 1.0 * NOISE_MASTER);
  }

  // ======== Notes / Chords ========
  const NOTE_TO_SEMITONE = {
    C:0, "C#":1, Db:1,
    D:2, "D#":3, Eb:3,
    E:4,
    F:5, "F#":6, Gb:6,
    G:7, "G#":8, Ab:8,
    A:9, "A#":10, Bb:10,
    B:11
  };

  const QUALITIES = {
    maj:  { label:"メジャー",   intervals:[0,4,7] },
    min:  { label:"マイナー",   intervals:[0,3,7] },
    maj7: { label:"メジャー7",  intervals:[0,4,7,11] },
    min7: { label:"マイナー7",  intervals:[0,3,7,10] },
  };

  function noteToMidi(note, octave){
    return 12 * (octave + 1) + NOTE_TO_SEMITONE[note]; // C4=60
  }
  function midiToHz(midi){
    return 440 * Math.pow(2, (midi - 69) / 12);
  }

  function chordNameJP(root, qualKey){
    const q = QUALITIES[qualKey];
    if (!q) return String(root);
    // 表示用：♭/♯に寄せる
    const pretty = root
      .replace("b","♭")
      .replace("#","＃"); // 全角シャープ
    return `${pretty}${q.label}`;
  }

  function chordShortLabel(root, qualKey){
    const pretty = String(root).replace("b","♭");
    if (qualKey === "maj") return `${pretty}`;
    if (qualKey === "min") return `${pretty}m`;
    if (qualKey === "maj7") return `${pretty}7`;
    if (qualKey === "min7") return `${pretty}m7`;
    return `${pretty}`;
  }

  // ======== Chord Channels (0..9) ========
  // 初期値は従来の0..9互換
  const chordChannels = [
    { root:"A",  qual:"maj" }, // 0
    { root:"A",  qual:"min" }, // 1
    { root:"Bb", qual:"maj" }, // 2
    { root:"C",  qual:"maj" }, // 3
    { root:"D",  qual:"maj" }, // 4
    { root:"D",  qual:"min" }, // 5
    { root:"E",  qual:"maj" }, // 6
    { root:"E",  qual:"min7" }, // 7  (旧: Eマイナー7)
    { root:"F",  qual:"maj" }, // 8
    { root:"G",  qual:"maj" }, // 9
  ];

  // ======== Audio Engine ========
  const AudioContext = window.AudioContext || window.webkitAudioContext;
  let ctx = null;
  let running = false;

  let engine = Array.from({length: VOICES}, () => ({
    osc:null, mix:null, osc2:null, mix2:null, filter:null, amp:null, lfo:null, lfoGain:null
  }));

  const MASTER = { gain:null };
  const NOISE = { src:null, lpf:null, gain:null };
  const FADE = 0.03;

  function ensureCtx(){
    if (!ctx) ctx = new AudioContext();
    return ctx;
  }

  function setParamSmooth(param, value, tc=0.01){
    const t = ctx.currentTime;
    try { param.cancelScheduledValues(t); } catch {}
    param.setTargetAtTime(value, t, tc);
  }

  function volToGain(v0_100){
    const x = Math.max(0, Math.min(100, v0_100)) / 100;
    return x * x;
  }

  function modRateToHz(rateInt1_200){
    return Math.max(0.1, Math.min(20.0, rateInt1_200 / 10));
  }

  function effectiveAmpGain(st){
    return st.muted ? 0.0001 : Math.max(0.0001, volToGain(st.vol));
  }

  function createGlobalNoise(){
    const len = Math.max(1, Math.floor(ctx.sampleRate * 1.0));
    const buf = ctx.createBuffer(1, len, ctx.sampleRate);
    const d = buf.getChannelData(0);
    for (let i=0;i<len;i++) d[i] = (Math.random() * 2 - 1);

    NOISE.src = ctx.createBufferSource();
    NOISE.src.buffer = buf;
    NOISE.src.loop = true;

    NOISE.lpf = ctx.createBiquadFilter();
    NOISE.lpf.type = "lowpass";
    NOISE.lpf.frequency.value = noiseState.color;
    NOISE.lpf.Q.value = 0.707;

    NOISE.gain = ctx.createGain();
    NOISE.gain.gain.value = noiseAmountToGain(noiseState.amount);

    NOISE.src.connect(NOISE.lpf);
    NOISE.lpf.connect(NOISE.gain);
    NOISE.gain.connect(MASTER.gain);

    NOISE.src.start();
  }

  function applyNoiseToEngine(immediate=false){
    if (!running || !NOISE.gain || !NOISE.lpf) return;
    const tc = immediate ? 0.001 : 0.02;
    setParamSmooth(NOISE.gain.gain, noiseAmountToGain(noiseState.amount), tc);
    setParamSmooth(NOISE.lpf.frequency, noiseState.color, tc);
  }

  function createVoiceNodes(i){
    const st = voicesState[i];
    const e = engine[i];

    e.filter = ctx.createBiquadFilter();
    e.filter.type = "lowpass";
    e.filter.frequency.value = st.filt;
    e.filter.Q.value = 0.707;

    e.amp = ctx.createGain();
    e.amp.gain.value = 0.0001;

    e.osc = ctx.createOscillator();
    e.osc.type = st.wave;
    e.osc.frequency.value = st.freq;

    e.mix = ctx.createGain();
    e.mix.gain.value = 1.0;

    e.osc.connect(e.mix);
    e.mix.connect(e.filter);
    e.filter.connect(e.amp);

    e.lfo = ctx.createOscillator();
    e.lfo.type = "sine";
    e.lfo.frequency.value = modRateToHz(st.modRate);

    e.lfoGain = ctx.createGain();
    e.lfoGain.gain.value = st.modDepth;

    e.lfo.connect(e.lfoGain);
    e.lfoGain.connect(e.osc.frequency);

    e.amp.connect(MASTER.gain);

    e.osc.start();
    e.lfo.start();
  }

  function startAll(){
    ensureCtx();
    if (ctx.state === "suspended") ctx.resume();

    if (!MASTER.gain){
      MASTER.gain = ctx.createGain();
      MASTER.gain.gain.value = 0.9;
      MASTER.gain.connect(ctx.destination);
    }

    for (let i=0;i<VOICES;i++){
      engine[i] = { osc:null, mix:null, osc2:null, mix2:null, filter:null, amp:null, lfo:null, lfoGain:null };
      createVoiceNodes(i);
    }

    if (!NOISE.src) createGlobalNoise();

    running = true;
    document.getElementById("playBtn").disabled = true;
    document.getElementById("stopBtn").disabled = false;

    for (let i=0;i<VOICES;i++) applyStateToEngine(i, true);
    applyNoiseToEngine(true);
  }

  function stopAll(){
    if (!running) return;
    const t = ctx.currentTime;

    for (let i=0;i<VOICES;i++){
      const e = engine[i];
      if (e.amp){
        const g = e.amp.gain;
        try { g.cancelScheduledValues(t); } catch {}
        g.setValueAtTime(g.value, t);
        g.linearRampToValueAtTime(0.0001, t + 0.04);
      }
      const stopAt = t + 0.06;
      try { e.osc && e.osc.stop(stopAt); } catch {}
      try { e.osc2 && e.osc2.stop(stopAt); } catch {}
      try { e.lfo && e.lfo.stop(stopAt); } catch {}
    }

    const stopAtN = t + 0.06;
    if (NOISE.gain && NOISE.gain.gain){
      try { NOISE.gain.gain.cancelScheduledValues(t); } catch {}
      NOISE.gain.gain.setValueAtTime(NOISE.gain.gain.value, t);
      NOISE.gain.gain.linearRampToValueAtTime(0.0001, t + 0.04);
    }
    try { NOISE.src && NOISE.src.stop(stopAtN); } catch {}

    NOISE.src = null; NOISE.lpf = null; NOISE.gain = null;

    running = false;
    document.getElementById("playBtn").disabled = false;
    document.getElementById("stopBtn").disabled = true;
  }

  function crossfadeWave(i, newWave){
    const e = engine[i];
    if (!running || !e.osc || !e.mix || !e.filter) return;
    if (e.osc.type === newWave) return;

    if (e.osc2){
      try { e.osc2.stop(); } catch {}
      e.osc2 = null;
      e.mix2 = null;
    }

    const st = voicesState[i];

    e.osc2 = ctx.createOscillator();
    e.osc2.type = newWave;
    e.osc2.frequency.value = st.freq;

    e.mix2 = ctx.createGain();
    e.mix2.gain.value = 0.0;

    e.osc2.connect(e.mix2);
    e.mix2.connect(e.filter);
    if (e.lfoGain) e.lfoGain.connect(e.osc2.frequency);

    e.osc2.start();

    const t = ctx.currentTime;

    e.mix.gain.cancelScheduledValues(t);
    e.mix2.gain.cancelScheduledValues(t);

    e.mix.gain.setValueAtTime(e.mix.gain.value, t);
    e.mix2.gain.setValueAtTime(e.mix2.gain.value, t);

    e.mix.gain.linearRampToValueAtTime(0.0001, t + FADE);
    e.mix2.gain.linearRampToValueAtTime(1.0, t + FADE);

    const oldOsc = e.osc;
    const oldMix = e.mix;

    setTimeout(() => {
      if (!running) return;
      try { oldOsc.stop(); } catch {}
      try { oldMix.disconnect(); } catch {}
      e.osc = e.osc2;
      e.mix = e.mix2;
      e.osc2 = null;
      e.mix2 = null;
    }, Math.ceil((FADE + 0.01) * 1000));
  }

  function applyStateToEngine(i, immediate=false){
    const st = voicesState[i];
    const e = engine[i];
    if (!running || !e.osc || !e.filter || !e.amp || !e.lfo || !e.lfoGain) return;

    const tc = immediate ? 0.001 : 0.02;

    setParamSmooth(e.amp.gain, effectiveAmpGain(st), tc);
    setParamSmooth(e.osc.frequency, st.freq, 0.01);
    if (e.osc2) setParamSmooth(e.osc2.frequency, st.freq, 0.01);

    setParamSmooth(e.filter.frequency, st.filt, 0.02);
    setParamSmooth(e.lfoGain.gain, st.modDepth, 0.02);
    setParamSmooth(e.lfo.frequency, modRateToHz(st.modRate), 0.02);

    crossfadeWave(i, st.wave);
  }

  // ======== UI Wiring (cards) ========
  const cards = Array.from(document.querySelectorAll(".card"));

  function formatValue(param, v, vi){
    const st = voicesState[vi];
    if (param === "vol") return st.muted ? `MUTED (${v}/100)` : `${v} / 100`;
    if (param === "freq") return `${v} Hz`;
    if (param === "filt") return `${v} Hz`;
    if (param === "modDepth") return `${v} Hz`;
    if (param === "modRate") return `${(v/10).toFixed(1)} Hz`;
    if (param === "wave") return `${v}`;
    return String(v);
  }

  function readCardValue(card){
    const param = card.dataset.param;
    if (param === "wave") return card.querySelector("select").value;
    return Number(card.querySelector('input[type="range"]').value);
  }

  function writeCardValue(card, value){
    const param = card.dataset.param;
    const vi = Number(card.dataset.voice);

    if (param === "wave"){
      card.querySelector("select").value = value;
    } else {
      card.querySelector('input[type="range"]').value = String(value);
    }
    card.querySelector(".val").textContent = formatValue(param, value, vi);

    if (param === "vol"){
      const mb = card.querySelector(".muteBtn");
      if (mb) mb.classList.toggle("on", voicesState[vi].muted);
    }
  }

  function syncCardToState(card){
    const vi = Number(card.dataset.voice);
    const param = card.dataset.param;
    const v = readCardValue(card);

    if (param === "wave"){
      voicesState[vi].wave = v;
      writeCardValue(card, v);
    } else {
      voicesState[vi][param] = v;
      writeCardValue(card, v);
    }
    applyStateToEngine(vi);
  }

  for (const card of cards){
    const vi = Number(card.dataset.voice);
    const param = card.dataset.param;

    if (param === "wave"){
      const v = card.querySelector("select").value;
      voicesState[vi].wave = v;
      writeCardValue(card, v);
    } else {
      const v = Number(card.querySelector('input[type="range"]').value);
      voicesState[vi][param] = v;
      writeCardValue(card, v);
    }
  }

  for (const card of cards){
    const vi = Number(card.dataset.voice);
    const param = card.dataset.param;

    if (param === "wave"){
      card.querySelector("select").addEventListener("change", () => syncCardToState(card));
    } else {
      card.querySelector('input[type="range"]').addEventListener("input", () => syncCardToState(card));
    }

    const up = card.querySelector("button.up");
    const down = card.querySelector("button.down");

    const stepOne = (dir) => {
      if (param === "wave"){
        const sel = card.querySelector("select");
        const idx = WAVE_ORDER.indexOf(sel.value);
        const next = Math.max(0, Math.min(WAVE_ORDER.length-1, idx + dir));
        sel.value = WAVE_ORDER[next];
        sel.dispatchEvent(new Event("change", { bubbles:true }));
        return;
      }
      const inp = card.querySelector('input[type="range"]');
      const min = Number(inp.min), max = Number(inp.max);
      const cur = Number(inp.value);
      const nxt = Math.max(min, Math.min(max, cur + dir));
      inp.value = String(nxt);
      inp.dispatchEvent(new Event("input", { bubbles:true }));
    };

    up.addEventListener("click", () => stepOne(+1));
    down.addEventListener("click", () => stepOne(-1));

    if (param === "vol"){
      const muteBtn = card.querySelector(".muteBtn");
      muteBtn.addEventListener("click", () => {
        voicesState[vi].muted = !voicesState[vi].muted;
        const v = Number(card.querySelector('input[type="range"]').value);
        writeCardValue(card, v);
        applyStateToEngine(vi);
      });
      muteBtn.classList.toggle("on", voicesState[vi].muted);
    }
  }

  // ======== Noise UI ========
  const noiseAmt = document.getElementById("noiseAmt");
  const noiseCol = document.getElementById("noiseCol");
  const noiseAmtVal = document.getElementById("noiseAmtVal");
  const noiseColVal = document.getElementById("noiseColVal");

  function syncNoiseLabels(){
    noiseAmtVal.textContent = `${noiseState.amount} / 100`;
    noiseColVal.textContent = `${noiseState.color} Hz`;
  }
  syncNoiseLabels();

  noiseAmt.addEventListener("input", () => {
    noiseState.amount = Number(noiseAmt.value);
    syncNoiseLabels();
    applyNoiseToEngine();
  });
  noiseCol.addEventListener("input", () => {
    noiseState.color = Number(noiseCol.value);
    syncNoiseLabels();
    applyNoiseToEngine();
  });

  // ======== Chord Channel UI + Registration ========
  const chChanSel = document.getElementById("chChanSel");
  const octSel = document.getElementById("octSel");

  const regChanSel = document.getElementById("regChanSel");
  const regRootSel = document.getElementById("regRootSel");
  const regQualSel = document.getElementById("regQualSel");
  const regCommitBtn = document.getElementById("regCommitBtn");

  const ROOT_OPTIONS = [
    ["A","A"], ["Ab","A♭"], ["A#","A＃"],
    ["B","B"], ["Bb","B♭"],
    ["C","C"], ["C#","C＃"],
    ["D","D"], ["Db","D♭"], ["D#","D＃"],
    ["E","E"], ["Eb","E♭"],
    ["F","F"], ["F#","F＃"],
    ["G","G"], ["Gb","G♭"], ["G#","G＃"],
  ];

  function rebuildChannelOptions(){
    chChanSel.innerHTML = "";
    for (let i=0;i<10;i++){
      const cc = chordChannels[i];
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = `${i}: ${chordNameJP(cc.root, cc.qual)}`;
      chChanSel.appendChild(opt);
    }
    updateChannelMap();
  }

  function rebuildRegOptions(){
    regChanSel.innerHTML = "";
    for (let i=0;i<10;i++){
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = `チャンネル ${i}`;
      regChanSel.appendChild(opt);
    }

    regRootSel.innerHTML = "";
    for (const [val, label] of ROOT_OPTIONS){
      const opt = document.createElement("option");
      opt.value = val;
      opt.textContent = label;
      regRootSel.appendChild(opt);
    }

    regQualSel.innerHTML = "";
    for (const key of ["maj","min","maj7","min7"]){
      const opt = document.createElement("option");
      opt.value = key;
      opt.textContent = QUALITIES[key].label;
      regQualSel.appendChild(opt);
    }
  }

  function updateChannelMap(){
    const el = document.getElementById("chMapText");
    if (!el) return;
    el.innerHTML = "";
    for (let i=0;i<10;i++){
      const cc = chordChannels[i];
      const span = document.createElement("span");
      span.textContent = `${i}:${chordShortLabel(cc.root, cc.qual)}`;
      el.appendChild(span);
    }
  }

  rebuildChannelOptions();
  rebuildRegOptions();
  updateChannelMap();

  // ======== Chord apply (overwrite frequencies only) ========
  function overwriteFrequenciesByChannel(channelIndex){
    const octave = Number(octSel.value);
    const cc = chordChannels[channelIndex];
    if (!cc) return;
    const qual = QUALITIES[cc.qual];
    if (!qual) return;

    const rootMidi = noteToMidi(cc.root, octave);
    let mids = qual.intervals.map(x => rootMidi + x);

    // triad -> add octave root so that Cmaj becomes C E G C
    if (mids.length === 3){
      mids.push(rootMidi + 12);
    }

    // maj7 / dom7 : drop 7th down (Root-7th-3rd-5th)
    if (cc.qual === "maj7"){
      // intervals: [0,4,7,11] -> reorder as [0,11,4,7]
      mids = [rootMidi, rootMidi+11, rootMidi+4, rootMidi+7];
    }

    // sort low..high, keep 4 notes
    mids = mids.sort((a,b)=>a-b).slice(0,4);

    // "基本的には7の音はAに割り当てる"
    // 7th系（4音）では、最高音＝最後の要素になるようにしておけばAが7thになる（標準配置で成立）
    const freqs = mids.map(midiToHz);

    // A highest ... D lowest
    voicesState[0].freq = Math.round(freqs[3]);
    voicesState[1].freq = Math.round(freqs[2]);
    voicesState[2].freq = Math.round(freqs[1]);
    voicesState[3].freq = Math.round(freqs[0]);

    for (const card of cards){
      if (card.dataset.param !== "freq") continue;
      const vi = Number(card.dataset.voice);
      writeCardValue(card, voicesState[vi].freq);
    }

    if (running){
      for (let i=0;i<VOICES;i++) applyStateToEngine(i);
    }
  }

  function currentChannelIndex(){
    return Math.max(0, Math.min(9, Number(chChanSel.value)));
  }

  chChanSel.addEventListener("change", () => {
    overwriteFrequenciesByChannel(currentChannelIndex());
  });

  octSel.addEventListener("change", () => {
    overwriteFrequenciesByChannel(currentChannelIndex());
  });

  regCommitBtn.addEventListener("click", () => {
    const idx = Math.max(0, Math.min(9, Number(regChanSel.value)));
    const root = regRootSel.value;
    const qual = regQualSel.value;

    chordChannels[idx] = { root, qual };
    const cur = currentChannelIndex();
    rebuildChannelOptions();
    chChanSel.value = String(cur); // keep selection
    if (idx === cur){
      overwriteFrequenciesByChannel(cur);
    }
  });

  // ======== Keyboard shortcuts for channel 0..9 + octave A/S/D/F ========
  const OCT_KEY_TO_VALUE = { a:"2", s:"3", d:"4", f:"5" };

  window.addEventListener("keydown", (ev) => {
    if (ev.metaKey || ev.ctrlKey || ev.altKey) return;

    const key = ev.key;

    // channel 0..9
    if (key.length === 1 && key >= "0" && key <= "9") {
      const idx = Number(key);
      if (idx >= 0 && idx < 10){
        chChanSel.value = String(idx);
        overwriteFrequenciesByChannel(idx);
        ev.preventDefault();
      }
      return;
    }

    // octave A/S/D/F (C2/C3/C4/C5)
    const k = key.toLowerCase();
    if (OCT_KEY_TO_VALUE[k]) {
      octSel.value = OCT_KEY_TO_VALUE[k];
      overwriteFrequenciesByChannel(currentChannelIndex());
      ev.preventDefault();
      return;
    }
  });

  // 初期反映（チャンネル0）
  chChanSel.value = "0";
  overwriteFrequenciesByChannel(0);

  // ======== Play/Stop ========
  document.getElementById("playBtn").addEventListener("click", async () => {
    ensureCtx();
    if (ctx.state === "suspended") await ctx.resume();
    startAll();
    for (let i=0;i<VOICES;i++) applyStateToEngine(i, true);
    applyNoiseToEngine(true);
  });

  document.getElementById("stopBtn").addEventListener("click", stopAll);


  // ======== Space key : Play / Stop toggle ========
  window.addEventListener("keydown", (ev) => {
    if (ev.code === "Space") {
      ev.preventDefault();
      if (!running) {
        document.getElementById("playBtn").click();
      } else {
        document.getElementById("stopBtn").click();
      }
    }
  });


  // ======== Pseudo Page Switch (説明) ========
  const pageMain = document.getElementById("pageMain");
  const pageHelp = document.getElementById("pageHelp");
  const helpBtn = document.getElementById("helpBtn");
  const helpBackBtn = document.getElementById("helpBackBtn");

  function showHelpPage(){
    if (!pageMain || !pageHelp) return;
    pageMain.classList.add("hidden");
    pageHelp.classList.remove("hidden");
    // scroll to top for "page" feel
    try { window.scrollTo({ top: 0, left: 0, behavior: "instant" }); } catch { window.scrollTo(0,0); }
    if (helpBackBtn) helpBackBtn.focus();
  }
  function showMainPage(){
    if (!pageMain || !pageHelp) return;
    pageHelp.classList.add("hidden");
    pageMain.classList.remove("hidden");
    try { window.scrollTo({ top: 0, left: 0, behavior: "instant" }); } catch { window.scrollTo(0,0); }
    if (helpBtn) helpBtn.focus();
  }

  if (helpBtn) helpBtn.addEventListener("click", showHelpPage);
  if (helpBackBtn) helpBackBtn.addEventListener("click", showMainPage);

  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && pageHelp && !pageHelp.classList.contains("hidden")){
      e.preventDefault();
      showMainPage();
    }
  });

})();
</script>
</body>
</html>
